// ==UserScript==
// @name         hhanclubè‡ªåŠ¨æŠ½å¥–
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  è‡ªåŠ¨æ‰§è¡ŒhhanclubæŠ½å¥–
// @author       Timi
// @match        https://hhanclub.top/lucky.php
// @grant        none
// @icon         https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAKEE2ie35c8Z7uFMM3o7kGs8JLlxdoAA-EZAAKUwPlULub89nlMf6Y2BA.ico
// @run-at       document-ready
// @license      MIT
 
// ==/UserScript==
 
(function() {
    'use strict';
 
    // æŠ½å¥–APIé…ç½®
    const LOTTERY_API = 'https://hhanclub.top/plugin/lucky-draw';
 
    // åˆ›å»ºæ§åˆ¶é¢æ¿
    function createControlPanel() {
        const panel = document.createElement('div');
        panel.id = 'lottery-control-panel';
        panel.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            min-width: 280px;
            max-width: 500px;
            min-height: 200px;
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-family: Arial, sans-serif;
            padding: 15px;
            resize: both;
            overflow: auto;
        `;
 
        panel.innerHTML = `
            <div style="text-align: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #007bff;">ğŸ² è‡ªåŠ¨æŠ½å¥–å·¥å…·</h3>
            </div>
            <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ’° æ†¨è±†ä½™é¢: <span id="bean-balance" style="color: #28a745; font-weight: bold;">æ£€æµ‹ä¸­...</span></span>
                </div>
                <div style="margin-top: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ¯ å•æ¬¡æ¶ˆè€—: <span style="color: #dc3545;">2000</span></span>
                    <span>ğŸ“Š æœ€å¤šå¯æŠ½: <span id="max-possible" style="color: #007bff; font-weight: bold;">-</span> æ¬¡</span>
                </div>
            </div>
            <div style="margin-bottom: 10px;">
                <label>æŠ½å¥–é—´éš” (ç§’):</label>
                <input type="number" id="lottery-interval" value="8" min="3" max="300" style="width: 60px; margin-left: 10px;">
                <span style="font-size: 11px; color: #666; margin-left: 5px;">å®é™…: <span id="current-interval">8</span>s</span>
            </div>
            <div style="margin-bottom: 10px;">
                <label>æœ€å¤§æŠ½å¥–æ¬¡æ•°:</label>
                <input type="number" id="max-lottery-count" value="10" min="1" max="1000" style="width: 60px; margin-left: 10px;">
                <button id="set-max-possible" style="background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-left: 5px; cursor: pointer;">è®¾ä¸ºæœ€å¤§</button>
            </div>
            <div style="text-align: center; margin-bottom: 15px;">
                <button id="start-lottery" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-right: 5px; cursor: pointer;">å¼€å§‹æŠ½å¥–</button>
                <button id="stop-lottery" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;" disabled>åœæ­¢æŠ½å¥–</button>
            </div>
            <div style="border-top: 1px solid #eee; padding-top: 10px;">
                <div style="font-size: 12px; color: #666;">
                    çŠ¶æ€: <span id="lottery-status" style="color: #28a745;">ç­‰å¾…å¼€å§‹</span>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    å·²æŠ½å¥–: <span id="lottery-count">0</span> æ¬¡ | ä¸­å¥–: <span id="win-count">0</span> æ¬¡ | æ¶ˆè€—: <span id="cost-beans">0</span> æ†¨è±†
                </div>
                <div style="font-size: 12px; margin-top: 5px;">
                    <span style="color: #666;">ç›ˆäº: </span>
                    <span id="profit-loss" style="font-weight: bold;">-</span> æ†¨è±†
                    <span style="color: #666; margin-left: 10px;">ç›ˆäºç‡: </span>
                    <span id="profit-rate" style="font-weight: bold;">-</span>
                </div>
                <div id="prize-stats" style="font-size: 11px; color: #666; margin-top: 5px; display: none; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong>ğŸ å¥–å“ç»Ÿè®¡</strong>
                        <button id="toggle-detailed-stats" style="background: #6c757d; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 10px; cursor: pointer;">è¯¦ç»†</button>
                    </div>
                    <div id="summary-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-bottom: 5px; font-size: 10px;">
                        <div>ğŸ’° è·å¾—æ†¨è±†: <span id="total-beans-won" style="color: #28a745; font-weight: bold;">0</span></div>
                        <div>ğŸ“§ é‚€è¯·æ•°: <span id="total-invites" style="color: #007bff; font-weight: bold;">0</span></div>
                        <div>ğŸŒˆ å½©è™¹ID: <span id="total-rainbow-days" style="color: #e83e8c; font-weight: bold;">0</span>å¤©</div>
                        <div>ğŸ« VIP: <span id="total-vip-days" style="color: #fd7e14; font-weight: bold;">0</span>å¤©</div>
                        <div>ğŸ“ è¡¥ç­¾å¡: <span id="total-makeup-cards" style="color: #6f42c1; font-weight: bold;">0</span>ä¸ª</div>
                        <div>â¬†ï¸ ä¸Šä¼ é‡: <span id="total-upload" style="color: #20c997; font-weight: bold;">0</span>GB</div>
                    </div>
                    <div id="detailed-prize-list" style="max-height: 80px; overflow-y: auto; margin-top: 3px; border: 1px solid #ddd; border-radius: 3px; padding: 3px; resize: both; min-height: 40px; display: none;"></div>
                </div>
                <div id="lottery-log" style="max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 5px; border-radius: 4px; font-size: 11px; margin-top: 10px; display: none;">
                </div>
            </div>
        `;
 
        document.body.appendChild(panel);
        console.log('æ§åˆ¶é¢æ¿å·²æ·»åŠ :', document.getElementById('lottery-control-panel'));
        return panel;
    }
 
    // è·å–æ†¨è±†ä½™é¢
    function getBeanBalance() {
        const beanElement = document.querySelector('.bean-number');
        if (!beanElement) {
            console.error('æœªæ‰¾åˆ°æ†¨è±†ä½™é¢å…ƒç´  (.bean-number)');
            addLog('âŒ æ— æ³•è·å–æ†¨è±†ä½™é¢', 'error');
            return 0;
        }
        const balance = parseFloat(beanElement.textContent.trim());
        return isNaN(balance) ? 0 : balance;
    }
 
    // æ›´æ–°ä½™é¢æ˜¾ç¤º
    function updateBalanceDisplay() {
        const balance = getBeanBalance();
        const maxPossible = Math.floor(balance / 2000);
 
        const beanBalanceElement = document.getElementById('bean-balance');
        const maxPossibleElement = document.getElementById('max-possible');
        const startButton = document.getElementById('start-lottery');
 
        if (beanBalanceElement && maxPossibleElement && startButton) {
            beanBalanceElement.textContent = balance.toLocaleString();
            maxPossibleElement.textContent = maxPossible.toLocaleString();
 
            if (balance < 2000) {
                startButton.disabled = true;
                startButton.textContent = 'ä½™é¢ä¸è¶³';
                startButton.style.background = '#6c757d';
            } else {
                startButton.disabled = false;
                startButton.textContent = 'å¼€å§‹æŠ½å¥–';
                startButton.style.background = '#28a745';
            }
        } else {
            console.error('ä½™é¢æ˜¾ç¤ºå…ƒç´ æœªæ‰¾åˆ°');
            addLog('âŒ ä½™é¢æ˜¾ç¤ºå…ƒç´ æœªåŠ è½½', 'error');
        }
 
        return maxPossible;
    }
 
    // è§£ç Unicodeå­—ç¬¦ä¸²
    function decodeUnicode(str) {
        try {
            return str.replace(/\\u[\dA-F]{4}/gi, function(match) {
                return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
            });
        } catch (error) {
            return str;
        }
    }
 
    // æ‰§è¡Œå•æ¬¡æŠ½å¥–
    async function performLottery() {
        try {
            const response = await fetch(LOTTERY_API, {
                method: 'POST',
                headers: {
                    'accept': '*/*',
                    'accept-language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
                    'content-length': '0',
                    'origin': 'https://hhanclub.top',
                    'priority': 'u=1, i',
                    'referer': 'https://hhanclub.top/lucky.php',
                    'sec-ch-ua': '"Not;A=Brand";v="99", "Microsoft Edge";v="139", "Chromium";v="139"',
                    'sec-ch-ua-arch': 'x86',
                    'sec-ch-ua-bitness': '64',
                    'sec-ch-ua-mobile': '?0',
                    'sec-ch-ua-platform': 'Windows',
                    'sec-fetch-dest': 'empty',
                    'sec-fetch-mode': 'cors',
                    'sec-fetch-site': 'same-origin',
                    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 Edg/139.0.0.0',
                    'x-requested-with': 'XMLHttpRequest'
                }
            });
 
            const resultText = await response.text();
 
            let parsedResult = null;
            try {
                parsedResult = JSON.parse(resultText);
            } catch (e) {
                // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œä¿æŒåŸæ–‡æœ¬
            }
 
            return {
                success: response.ok,
                status: response.status,
                data: resultText,
                parsed: parsedResult
            };
        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }
 
    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
        const logContainer = document.getElementById('lottery-log');
        if (!logContainer) {
            console.error('æ—¥å¿—å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
        logContainer.style.display = 'block';
 
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
 
        let color = '#666';
        switch(type) {
            case 'error': color = '#dc3545'; break;
            case 'success': color = '#28a745'; break;
            case 'warning': color = '#ffc107'; break;
            case 'info':
            default: color = '#666'; break;
        }
 
        logEntry.style.cssText = `margin-bottom: 3px; color: ${color};`;
        logEntry.textContent = `[${timestamp}] ${message}`;
 
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
 
        if (logContainer.children.length > 20) {
            logContainer.removeChild(logContainer.firstChild);
        }
    }
 
    // å¥–å“ç»Ÿè®¡
    let prizeStats = {};
    let winCount = 0;
    let totalCost = 0;
    let totalBeansWon = 0;
    let totalInvites = 0;
    let totalRainbowDays = 0;
    let totalVipDays = 0;
    let totalMakeupCards = 0;
    let totalUploadGB = 0;
 
    // è§£æå¥–å“å†…å®¹
    function parsePrizeText(prizeText) {
        const result = {
            type: 'unknown',
            name: prizeText,
            value: 0,
            unit: ''
        };
 
        if (prizeText.includes('é­”åŠ›') || prizeText.includes('æ†¨è±†')) {
            const match = prizeText.match(/(\d+)/);
            if (match) {
                result.type = 'beans';
                result.value = parseInt(match[1]);
                result.name = 'æ†¨è±†';
                result.unit = '';
            }
        }
        else if (prizeText.includes('é‚€è¯·')) {
            const match = prizeText.match(/(\d+)/);
            if (match) {
                result.type = 'invite';
                result.value = parseInt(match[1]);
                result.name = 'é‚€è¯·';
                result.unit = '';
            }
        }
        else if (prizeText.includes('å½©è™¹')) {
            const match = prizeText.match(/(\d+)/);
            if (match) {
                result.type = 'rainbow';
                result.value = parseInt(match[1]);
                result.name = 'å½©è™¹ID';
                result.unit = 'å¤©';
            }
        }
        else if (prizeText.includes('VIP')) {
            const match = prizeText.match(/(\d+)/);
            if (match) {
                result.type = 'vip';
                result.value = parseInt(match[1]);
                result.name = 'VIP';
                result.unit = 'å¤©';
            }
        }
        else if (prizeText.includes('è¡¥ç­¾å¡')) {
            const match = prizeText.match(/(\d+)/);
            if (match) {
                result.type = 'makeup';
                result.value = parseInt(match[1]);
                result.name = 'è¡¥ç­¾å¡';
                result.unit = 'ä¸ª';
            }
        }
        else if (prizeText.includes('ä¸Šä¼ é‡')) {
            const match = prizeText.match(/(\d+(?:\.\d+)?)\s*GB/);
            if (match) {
                result.type = 'upload';
                result.value = parseFloat(match[1]);
                result.name = 'ä¸Šä¼ é‡';
                result.unit = 'GB';
            }
        }
 
        return result;
    }
 
    // æ›´æ–°å¥–å“ç»Ÿè®¡
    function updatePrizeStats(prizeText) {
        winCount++;
        document.getElementById('win-count').textContent = winCount;
 
        const prize = parsePrizeText(prizeText);
 
        switch(prize.type) {
            case 'beans':
                totalBeansWon += prize.value;
                document.getElementById('total-beans-won').textContent = totalBeansWon.toLocaleString();
                break;
            case 'invite':
                totalInvites += prize.value;
                document.getElementById('total-invites').textContent = totalInvites.toLocaleString();
                break;
            case 'rainbow':
                totalRainbowDays += prize.value;
                document.getElementById('total-rainbow-days').textContent = totalRainbowDays.toLocaleString();
                break;
            case 'vip':
                totalVipDays += prize.value;
                document.getElementById('total-vip-days').textContent = totalVipDays.toLocaleString();
                break;
            case 'makeup':
                totalMakeupCards += prize.value;
                document.getElementById('total-makeup-cards').textContent = totalMakeupCards.toLocaleString();
                break;
            case 'upload':
                totalUploadGB += prize.value;
                document.getElementById('total-upload').textContent = totalUploadGB.toLocaleString();
                break;
        }
 
        if (prizeStats[prizeText]) {
            prizeStats[prizeText]++;
        } else {
            prizeStats[prizeText] = 1;
        }
 
        updateProfitLoss();
        document.getElementById('prize-stats').style.display = 'block';
        updateDetailedPrizeList();
    }
 
    // æ›´æ–°ç›ˆäºè®¡ç®—
    function updateProfitLoss() {
        const profit = totalBeansWon - totalCost;
        const profitElement = document.getElementById('profit-loss');
        const rateElement = document.getElementById('profit-rate');
 
        if (profitElement && rateElement) {
            profitElement.textContent = profit.toLocaleString();
            if (profit > 0) {
                profitElement.style.color = '#28a745';
                profitElement.textContent = '+' + profit.toLocaleString();
            } else if (profit < 0) {
                profitElement.style.color = '#dc3545';
            } else {
                profitElement.style.color = '#666';
            }
 
            if (totalCost > 0) {
                const rate = (profit / totalCost * 100).toFixed(1);
                rateElement.textContent = rate + '%';
                if (parseFloat(rate) > 0) {
                    rateElement.style.color = '#28a745';
                } else if (parseFloat(rate) < 0) {
                    rateElement.style.color = '#dc3545';
                } else {
                    rateElement.style.color = '#666';
                }
            } else {
                rateElement.textContent = '-';
                rateElement.style.color = '#666';
            }
        }
    }
 
    // æ›´æ–°è¯¦ç»†å¥–å“åˆ—è¡¨
    function updateDetailedPrizeList() {
        const prizeList = document.getElementById('detailed-prize-list');
        if (!prizeList) return;
 
        prizeList.innerHTML = '';
        Object.entries(prizeStats)
            .sort((a, b) => b[1] - a[1])
            .forEach(([prize, count]) => {
                const item = document.createElement('div');
                item.textContent = `${prize}: ${count}æ¬¡`;
                item.style.cssText = 'margin: 1px 0; padding: 1px 3px; background: #e9ecef; border-radius: 2px;';
                prizeList.appendChild(item);
            });
    }
 
    // æ›´æ–°æ¶ˆè€—ç»Ÿè®¡
    function updateCostStats() {
        totalCost += 2000;
        document.getElementById('cost-beans').textContent = totalCost.toLocaleString();
        updateProfitLoss();
        setTimeout(updateBalanceDisplay, 100);
    }
 
    // ä¸»æ§åˆ¶é€»è¾‘
    let lotteryInterval = null;
    let lotteryCount = 0;
    let consecutiveErrors = 0;
    let dynamicInterval = 8000;
 
    function startLottery() {
        const intervalInput = document.getElementById('lottery-interval');
        const maxCountInput = document.getElementById('max-lottery-count');
 
        if (!intervalInput || !maxCountInput) {
            addLog('âŒ æ§åˆ¶é¢æ¿æœªæ­£ç¡®åŠ è½½ï¼Œæ— æ³•å¼€å§‹æŠ½å¥–', 'error');
            console.error('ç¼ºå°‘å¿…è¦çš„è¾“å…¥å…ƒç´ :', { intervalInput, maxCountInput });
            return;
        }
 
        const maxCount = parseInt(maxCountInput.value) || 10;
        dynamicInterval = parseInt(intervalInput.value) * 1000 || 8000;
 
        lotteryCount = 0;
        winCount = 0;
        totalCost = 0;
        consecutiveErrors = 0;
        prizeStats = {};
        totalBeansWon = 0;
        totalInvites = 0;
        totalRainbowDays = 0;
        totalVipDays = 0;
        totalMakeupCards = 0;
        totalUploadGB = 0;
 
        document.getElementById('lottery-count').textContent = '0';
        document.getElementById('win-count').textContent = '0';
        document.getElementById('cost-beans').textContent = '0';
        document.getElementById('current-interval').textContent = dynamicInterval / 1000;
        document.getElementById('prize-stats').style.display = 'none';
 
        document.getElementById('total-beans-won').textContent = '0';
        document.getElementById('total-invites').textContent = '0';
        document.getElementById('total-rainbow-days').textContent = '0';
        document.getElementById('total-vip-days').textContent = '0';
        document.getElementById('total-makeup-cards').textContent = '0';
        document.getElementById('total-upload').textContent = '0';
        document.getElementById('profit-loss').textContent = '-';
        document.getElementById('profit-rate').textContent = '-';
 
        document.getElementById('lottery-status').textContent = 'è¿è¡Œä¸­...';
        document.getElementById('lottery-status').style.color = '#ffc107';
        document.getElementById('start-lottery').disabled = true;
        document.getElementById('stop-lottery').disabled = false;
 
        addLog(`ğŸš€ å¼€å§‹è‡ªåŠ¨æŠ½å¥–ï¼ŒåŸºç¡€é—´éš”: ${dynamicInterval/1000}ç§’ï¼Œæœ€å¤§æ¬¡æ•°: ${maxCount}`, 'info');
 
        performSingleLottery(maxCount);
        lotteryInterval = setInterval(() => {
            performSingleLottery(maxCount);
        }, dynamicInterval);
    }
 
    // æ‰§è¡Œå•æ¬¡æŠ½å¥–
    async function performSingleLottery(maxCount) {
        if (lotteryCount >= maxCount) {
            stopLottery();
            addLog(`ğŸ¯ è¾¾åˆ°æœ€å¤§æŠ½å¥–æ¬¡æ•° (${maxCount})ï¼Œè‡ªåŠ¨åœæ­¢`, 'info');
            return;
        }
 
        lotteryCount++;
        document.getElementById('lottery-count').textContent = lotteryCount;
 
        addLog(`ğŸ¯ æ‰§è¡Œç¬¬ ${lotteryCount} æ¬¡æŠ½å¥–... (é—´éš”: ${dynamicInterval/1000}s)`, 'info');
 
        const result = await performLottery();
 
        if (result.success && result.parsed) {
            const data = result.parsed;
 
            if (data.ret === 0) {
                consecutiveErrors = 0;
                dynamicInterval = parseInt(document.getElementById('lottery-interval')?.value || 8) * 1000;
                document.getElementById('current-interval').textContent = dynamicInterval / 1000;
 
                if (lotteryInterval) {
                    clearInterval(lotteryInterval);
                    lotteryInterval = setInterval(() => {
                        performSingleLottery(maxCount);
                    }, dynamicInterval);
                }
 
                const prizeText = decodeUnicode(data.data.prize_text || 'æœªçŸ¥å¥–å“');
                const recordId = data.data.winning_record_id || '';
 
                addLog(`ğŸ‰ æ­å–œï¼æŠ½ä¸­äº†: ${prizeText} (è®°å½•ID: ${recordId})`, 'success');
 
                updatePrizeStats(prizeText);
                updateCostStats();
 
            } else if (data.ret === -1) {
                const errorMsg = decodeUnicode(data.msg || 'æœªçŸ¥é”™è¯¯');
 
                if (errorMsg.includes('é‡å¤ç‚¹å‡»') || errorMsg.includes('è¯·ç¨å')) {
                    consecutiveErrors++;
                    if (consecutiveErrors >= 3) {
                        dynamicInterval = Math.min(dynamicInterval * 1.5, 30000);
                        document.getElementById('current-interval').textContent = Math.round(dynamicInterval / 1000);
                        addLog(`âš ï¸ ${errorMsg}ï¼Œå·²è°ƒæ•´é—´éš”è‡³ ${Math.round(dynamicInterval/1000)} ç§’`, 'warning');
 
                        if (lotteryInterval) {
                            clearInterval(lotteryInterval);
                            lotteryInterval = setInterval(() => {
                                performSingleLottery(maxCount);
                            }, dynamicInterval);
                        }
                    } else {
                        addLog(`âš ï¸ ${errorMsg}ï¼Œå°†åœ¨ä¸‹æ¬¡ç»§ç»­å°è¯• (${consecutiveErrors}/3)`, 'warning');
                    }
                } else if (errorMsg.includes('æ¬¡æ•°') || errorMsg.includes('ç”¨å®Œ') || errorMsg.includes('ä½™é¢ä¸è¶³')) {
                    addLog(`âŒ ${errorMsg}ï¼Œå·²åœæ­¢æŠ½å¥–`, 'error');
                    stopLottery();
                    return;
                } else {
                    consecutiveErrors++;
                    addLog(`âŒ ${errorMsg} (${consecutiveErrors}/3)`, 'error');
                    updateCostStats();
                }
            } else {
                consecutiveErrors++;
                addLog(`âš ï¸ æœªçŸ¥å“åº”çŠ¶æ€: ret=${data.ret}, msg=${decodeUnicode(data.msg || '')}`, 'warning');
                updateCostStats();
            }
        } else if (result.success) {
            addLog(`âœ… æŠ½å¥–å®Œæˆï¼Œå“åº”: ${result.data.substring(0, 100)}...`, 'success');
            consecutiveErrors = 0;
        } else {
            consecutiveErrors++;
            addLog(`âŒ è¯·æ±‚å¤±è´¥: ${result.error || result.status} (${consecutiveErrors}/3)`, 'error');
        }
    }
 
    function stopLottery() {
        if (lotteryInterval) {
            clearInterval(lotteryInterval);
            lotteryInterval = null;
        }
 
        document.getElementById('lottery-status').textContent = 'å·²åœæ­¢';
        document.getElementById('lottery-status').style.color = '#dc3545';
        document.getElementById('start-lottery').disabled = false;
        document.getElementById('stop-lottery').disabled = true;
 
        const baseInterval = parseInt(document.getElementById('lotmechanized infantry-interval')?.value || 8);
        document.getElementById('current-interval').textContent = baseInterval;
 
        addLog('ğŸ›‘ æŠ½å¥–å·²åœæ­¢', 'info');
    }
 
    // åˆå§‹åŒ–
    function init() {
        const panel = createControlPanel();
        if (!panel || !document.getElementById('lottery-control-panel')) {
            console.error('æ§åˆ¶é¢æ¿åˆ›å»ºå¤±è´¥');
            addLog('âŒ æ§åˆ¶é¢æ¿åˆ›å»ºå¤±è´¥', 'error');
            return;
        }
 
        document.getElementById('start-lottery').addEventListener('click', startLottery);
        document.getElementById('stop-lottery').addEventListener('click', stopLottery);
 
        document.getElementById('set-max-possible').addEventListener('click', () => {
            const maxPossible = updateBalanceDisplay();
            document.getElementById('max-lottery-count').value = maxPossible;
        });
 
        document.getElementById('toggle-detailed-stats').addEventListener('click', () => {
            const detailedList = document.getElementById('detailed-prize-list');
            const button = document.getElementById('toggle-detailed-stats');
 
            if (detailedList.style.display === 'none') {
                detailedList.style.display = 'block';
                button.textContent = 'éšè—';
            } else {
                detailedList.style.display = 'none';
                button.textContent = 'è¯¦ç»†';
            }
        });
 
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
 
        const titleBar = panel.querySelector('h3').parentElement;
        titleBar.style.cursor = 'move';
        titleBar.style.userSelect = 'none';
 
        titleBar.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragOffset.x = e.clientX - panel.offsetLeft;
            dragOffset.y = e.clientY - panel.offsetTop;
        });
 
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                panel.style.left = (e.clientX - dragOffset.x) + 'px';
                panel.style.top = (e.clientY - dragOffset.y) + 'px';
                panel.style.right = 'auto';
            }
        });
 
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
 
        console.log('ğŸ² hhanclubè‡ªåŠ¨æŠ½å¥–è„šæœ¬å·²åŠ è½½ï¼');
        updateBalanceDisplay();
        setInterval(updateBalanceDisplay, 10000);
        addLog('è„šæœ¬å·²å°±ç»ªï¼Œç‚¹å‡»å¼€å§‹æŠ½å¥–å°†ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡æŠ½å¥–ï¼æ”¯æŒè¯¦ç»†å¥–å“ç»Ÿè®¡å’Œç›ˆäºåˆ†æ', 'success');
    }
 
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
